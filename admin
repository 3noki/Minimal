#!/bin/bash

pushd $(dirname ${BASH_SOURCE[0]}) > /dev/null

configuration=$(basename ${BASH_SOURCE[0]}).cfg
source "${configuration}"

bold=$(tty -s && tput bold)
regular=$(tty -s && tput sgr0)
underline=$(tty -s && tput smul)
error=$(tty -s && tput setaf 1)

server_start() {
    server_stop

    sudo rm -rf /var/log/nginx/${site}
    sudo mkdir -p /var/log/nginx/${site}

    echo "${bold}apt-get update${regular}"
    if [ ${runtime} = "node" ]; then
        if [ -z "$(which node)" ]; then
            curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
        fi
    fi
    if [ ! -f "/etc/apt/sources.list.d/nginx.list" ]; then
        echo "deb http://nginx.org/packages/ubuntu/ xenial nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
        echo "deb-src http://nginx.org/packages/ubuntu/ xenial nginx" | sudo tee -a /etc/apt/sources.list.d/nginx.list
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys ABF5BD827BD9BF62
    fi
    sudo apt-get -qq update

    echo "${bold}apt-get install nginx${regular}"
    sudo apt-get -qq install --yes nginx

    if [ ${runtime} = "go" ]; then 
        echo "${bold}apt-get install golang${regular}"
        sudo apt-get -qq install --yes golang
    elif [ ${runtime} = "python" ]; then
        echo "${bold}apt-get install python${regular}"
        sudo apt-get -qq install --yes python python-dateutil
    else
        echo "${bold}apt-get install nodejs${regular}"
        sudo apt-get -qq install --yes nodejs
    fi

    echo "${bold}install nginx.service${regular}"
    sudo systemctl stop nginx.service

cat << EOF >> "${site}.conf"

log_format ${site}_format '[\$time_local] \$status \$request_uri';

server {
    listen 80;
EOF
    if test -n "${domain}" && sudo test -f "/etc/letsencrypt/live/${domain}/fullchain.pem" && sudo test -f "/etc/letsencrypt/live/${domain}/privkey.pem"; then
cat << EOF >> "${site}.conf"
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/${domain}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${domain}/privkey.pem;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
    server_name ${domain};
    return 301 https://www.${domain}\$request_uri;
}
server {
    listen 80;
    server_name www.${domain};
    return 301 https://\$host\$request_uri;
}
server {
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/${domain}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${domain}/privkey.pem;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
    server_name www.${domain};
EOF
    fi
cat << EOF >> "${site}.conf"
    gzip on; gzip_proxied any; gzip_min_length 1000; gzip_http_version 1.0; gzip_disable 'msie6'; gzip_vary on;
    gzip_types text/plain text/css text/javascript application/json application/atom+xml application/rss+xml;
    location / {
        root /var/www/${site};
        access_log /var/log/nginx/${site}/access.log ${site}_format;
        error_log /var/log/nginx/${site}/access.log;
EOF
if [ -f "redirect.map" ]; then
    sed 's/\([^ ]*\)\( *\)\([^ ]*\)/        location ~ \1\2{ return 301 \3; }/g' redirect.map >> "${site}.conf"
fi
cat << EOF >> "${site}.conf"
        location ~ ^(.*)/index.html\$ {
            return 301 \$scheme://\$http_host\$1/;
        }
        location ~ ^(.*)/\$ {
            try_files \$1/index.html =404;
        }
        location ~ ^(/.*)/[^/]+\$ {
           error_page 404 =301 \$scheme://\$http_host\$1/;
        }
        error_page 404 =301 \$scheme://\$http_host/;
    }
}
EOF
    if [ $(which nginx) ]; then
        nginx_conf=$(dirname $(nginx -V 2>&1 | grep -o '\-\-conf-path=\(.*conf\)' | cut -d '=' -f2))/conf.d
        if sudo test -f "${nginx_conf}/default.conf"; then
            sudo mv "${nginx_conf}/default.conf" "${nginx_conf}/default.conf.backup"
        fi
        sudo mv "${site}.conf" "${nginx_conf}/${site}.conf"
        sudo systemctl start "nginx.service"
        if [ $(systemctl is-active "nginx.service") != "active" ]; then
            sudo systemctl status "nginx.service" --no-pager --lines=25 --full
            echo "${bold}${error}ngnix.service is not active.${regular}"
            return
        fi
    fi

    if sudo test -f "/etc/letsencrypt/live/${domain}/fullchain.pem" && sudo test -f "/etc/letsencrypt/live/${domain}/privkey.pem"; then
        echo "${bold}install ${site}-cert.service${regular}"
cat > "${site}-cert.service" << EOF
[Unit]
Description=${site}-cert.service
[Service]
Type=oneshot
WorkingDirectory=/opt/www/${site}
ExecStart=/bin/bash /opt/www/${site}/admin server cert
User=$(whoami)
Group=$(whoami)
SyslogIdentifier=${site}-cert.service
EOF
        sudo cp "${site}-cert.service" "/etc/systemd/system/${site}-cert.service"
        rm "${site}-cert.service"

        echo "${bold}install ${site}-cert.timer${regular}"
cat > "${site}-cert.timer" << EOF
[Unit]
Description=${site}-cert.timer
[Timer]
OnCalendar=Mon *-*-* 00:00:00
Persistent=true
Unit=${site}-cert.service
[Install]
WantedBy=timers.target
EOF
        sudo cp "${site}-cert.timer" "/etc/systemd/system/${site}-cert.timer"
        rm "${site}-cert.timer"
        sudo systemctl enable "${site}-cert.timer"
        sudo systemctl start "${site}-cert.timer"
        if [ $(systemctl is-active "${site}-cert.timer") != "active" ]; then
            sudo systemctl status "${site}-cert.timer" --no-pager --lines=25 --full
            echo "${bold}${error}${site}-cert.timer is not active.${regular}"
            return
        fi
    fi
}

server_stop() {
    if [ -f "/etc/systemd/system/${site}-cert.timer" ]; then
        echo "${bold}uninstall ${site}-cert.timer${regular}"
        if [ $(systemctl is-active "${site}-cert.timer") = "active" ]; then
            sudo systemctl stop "${site}-cert.timer"
            if [ $(systemctl is-active "${site}-cert.timer") != "inactive" ]; then
                sudo systemctl status "${site}-cert.timer" --no-pager --lines=25 --full
                echo "${bold}${error}${site}-cert.timer is not inactive.${regular}"
                return
            fi
        fi
        if [ $(systemctl is-enabled ${site}-cert.timer) = "enabled" ]; then
            sudo systemctl disable "${site}-cert.timer"
            if [ $(systemctl is-enabled "${site}-cert.timer") != "disabled" ]; then
                sudo systemctl status "${site}-cert.timer" --no-pager --lines=25 --full
                echo "${bold}${error}${site}-cert.timer is not disabled.${regular}"
                return
            fi
        fi
        sudo rm "/etc/systemd/system/${site}-cert.timer"
    fi
    if [ -f "/etc/systemd/system/${site}-cert.service" ]; then
        echo "${bold}uninstall ${site}-cert.service${regular}"
        sudo rm "/etc/systemd/system/${site}-cert.service"
    fi
    if [ $(which nginx) ]; then
        nginx_conf=$(dirname $(nginx -V 2>&1 | grep -o '\-\-conf-path=\(.*conf\)' | cut -d '=' -f2))/conf.d
        if [ -f "${nginx_conf}/${site}.conf" ]; then
            echo "${bold}uninstall nginx.service${regular}"
            sudo systemctl stop "nginx.service"
            if sudo test -f "${nginx_conf}/default.conf"; then
                sudo mv "${nginx_conf}/default.conf.backup" "${nginx_configuration}/default.conf"
            fi
            sudo rm "${nginx_conf}/${site}.conf"
            sudo systemctl start "nginx.service"
            if [ $(systemctl is-active "nginx.service") != "active" ]; then
                sudo systemctl status ngnix.service --no-pager --lines=25 --full
                echo "${bold}${error}ngnix.service is not active.${regular}"
                return
            fi
        fi
    fi
}

server_cert() {
    if [ -z ${domain} ] || [ -z ${email} ]; then
        echo "${bold}${error}Update 'domain' and 'email' in ${underline}${configuration}${regular}."
        return
    fi

    echo "${bold}apt-get install letsencrypt${regular}"
    sudo apt-get -qq update
    sudo apt-get -qq install --yes letsencrypt

    pushd /var/www/${site} > /dev/null
    mkdir .well-known
    if sudo test -f "/etc/letsencrypt/live/${domain}/fullchain.pem" && sudo test -f "/etc/letsencrypt/live/${domain}/privkey.pem"; then
        echo "${bold}renew certificate${regular}"
        sudo letsencrypt renew
    else
        echo "${bold}create certificate${regular}"
        mkdir -p .well-known/acme-challenge
        sudo letsencrypt certonly --webroot -w $(pwd) -d ${domain} -d www.${domain} -d cdn.${domain} --agree-tos --email ${email}
        rm letsencrypt.log
    fi
    rm -R .well-known
    popd > /dev/null

    echo "${bold}reload nginx.service${regular}"
    sudo systemctl stop "nginx.service"
    sudo systemctl start "nginx.service"
    if [ $(systemctl is-active "nginx.service") != "active" ]; then
        sudo systemctl status "nginx.service" --no-pager --lines=25 --full
        echo "${bold}${error}nginx.service is not active.${regular}"
    fi
}

server_log() {
    cat /var/log/nginx/${site}/access.log
}

server_pull() {
    echo "${bold}git fetch -p${regular}"
    git fetch -p
    branch=origin/$(git rev-parse --abbrev-ref HEAD)
    echo "${bold}git reset --hard ${branch}${regular}"
    git reset --hard ${branch}
}

server_update() {
    server_stop
    server_pull
    ./admin server deploy
    ./admin server start
}

server_deploy() {
    export ENVIRONMENT=production
    echo "${bold}build${regular}"
    client_build

    echo "${bold}deploy${regular}"
    sudo rm -rf /var/www/${site}/*
    sudo mkdir -p /var/www/${site}
    sudo cp -R build/${runtime}/* /var/www/${site}/
    sudo rm -rf /opt/www/${site}/*

    sudo mkdir -p /opt/www/${site}
    sudo cp admin /opt/www/${site}/
    sudo cp admin.cfg /opt/www/${site}/
    sudo cp redirect.map /opt/www/${site}/
}

client_build() {
    if [ ${1:-${runtime}} = "go" ]; then 
        go run tools/generator.go
    elif [ ${1:-${runtime}} = "python" ]; then
        python tools/generator.py
    else
        node tools/generator.js
    fi
}

client_start() {
    export ENVIRONMENT=development
    client_build ${1}
    if [ ${1:-${runtime}} = "go" ]; then 
        go run tools/server.go build/go --port 8080 --browse
    elif [ ${1:-${runtime}} = "python" ]; then
        python tools/server.py build/python --port 8080 --browse
    else
        node tools/server.js build/node --port 8080 --browse
    fi
}

client_log() {
    ssh -i ${identity} ${user}@${server} -tq -o "BatchMode yes" "/opt/www/${site}/admin server log"
}

client_update() {
    client_push
    echo "${bold}ssh ./admin server update${regular}"
    ssh -i ${identity} ${user}@${server} -tq -o "BatchMode yes" "${source}/admin server update"
}

client_push() {
    message=$@
    echo "${bold}git add -v *${regular}"
    git add -v *
    if [ -z "${message}" ]; then # if no description is provided amend last commit and push --force
        echo "${bold}git commit --amend --no-edit${regular}"
        git commit --amend --no-edit
        echo "${bold}git push --force${regular}"
        git push --force
    else # if description is provided create new commit and push
        echo "${bold}git commit -m '${message}'${regular}"
        git commit -m "${message}"
        echo "${bold}git push${regular}"
        git push
    fi
}

client_deploy() {
    export ENVIRONMENT=production
    echo "${bold}build${regular}"
    client_build ${1}
    runtime=${1:-${runtime}}
    echo "${bold}archive${regular}"
    pushd build/${runtime} > /dev/null
    zip ../../${site}-build.zip -r *
    popd > /dev/null
    zip ${site}-admin.zip admin admin.cfg redirect.map
    echo "${bold}secure copy${regular}"
    scp -i ${identity} -r ${site}-build.zip ${site}-admin.zip ${user}@${server}:~
    echo "${bold}server deploy${regular}"
    ssh -i ${identity} ${user}@${server} -t "sudo rm -rf /var/www/${site}/* && sudo rm -rf /opt/www/${site}/* && sudo mkdir -p /var/www/${site} && sudo mkdir -p /opt/www/${site} && sudo unzip ${site}-build.zip -d /var/www/lutzroeder && sudo unzip ${site}-admin.zip -d /opt/www/lutzroeder && rm ~/${site}-build.zip && rm ~/${site}-admin.zip"
    rm ${site}-*.zip
    ssh -i ${identity} ${user}@${server} -tq -o "BatchMode yes" "sudo /opt/www/${site}/admin server stop && sudo /opt/www/${site}/admin server start"
}

client_console() {
    ssh -i ${identity} ${user}@${server} -t "cd ${source} && exec bash -l"
}

client_test() {
    echo "${bold}node${regular}"
    ENVIRONMENT=production node tools/generator.js
    echo "${bold}go${regular}"
    ENVIRONMENT=production go run tools/generator.go
    echo "${bold}python${regular}"
    ENVIRONMENT=production python tools/generator.py
    echo "${bold}compare${regular}"
    diff --brief -r build/node/ build/go/
    diff --brief -r build/node/ build/python/
}

server() {
    command="$1"
    shift
    case "${command}" in
        "start") server_start;;
        "stop") server_stop;;
        "cert") server_cert;;
        "pull") server_pull;;
        "update") server_update;;
        "deploy") server_deploy;;
        "log") server_log;;
        *)
            echo;
            echo "Usage: ${bold}$(basename "$0")${regular} ${underline}server${regular} <command>"
            echo
            echo "    ${bold}start${regular}      Build website and install NGINX server"
            echo "    ${bold}stop${regular}       Disable NGINX configuration"
            echo "    ${bold}pull${regular}       Fetch Git repo and reset master branch"
            echo "    ${bold}deploy${regular}     Build and deploy from server Git clone"
            echo "    ${bold}update${regular}     Run stop, pull, deploy and start"
            echo "    ${bold}log${regular}        Show server log"
            echo "    ${bold}cert${regular}       Create or renew SSL certificate"
            echo;
        ;;
    esac
}

command="$1"
shift
case "${command}" in
    "build") client_build $@;;
    "start") client_start $@;;
    "deploy") client_deploy $@;;
    "push") client_push $@;;
    "update") client_update $@;;
    "log") client_log;;
    "console") client_console;;
    "test") client_test;;
    "server") server $@;;
    *)
        echo;
        echo "Usage: ${bold}$(basename "$0")${regular} <command>"
        echo
        echo "    ${bold}build${regular}      Build the website"
        echo "    ${bold}start${regular}      Build and launch simple web server"
        echo "    ${bold}deploy${regular}     Build locally and scp deploy to production server"
        echo "    ${bold}update${regular}     Git push then pull, build and deploy on production server"
        echo "    ${bold}log${regular}        Show production server log"
        echo "    ${bold}console${regular}    Connect to production server via SSH"
        echo "    ${bold}server${regular}     Run Ubuntu server commands"
        echo;
    ;;
esac

popd > /dev/null
