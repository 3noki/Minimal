#!/bin/bash

source "${BASH_SOURCE[0]}.cfg"

bold=$(tty -s && tput bold)
regular=$(tty -s && tput sgr0)
underline=$(tty -s && tput smul)
error=$(tty -s && tput setaf 1)

client_build() {
    if [ ${1:-${generator}} = "go" ]; then 
        go run tools/generator.go
    elif [ ${1:-${generator}} = "python" ]; then
        python tools/generator.py
    else
        node tools/generator.js
    fi
}

client_start() {
    export ENVIRONMENT=development
    client_build ${1}
    if [ ${1:-${generator}} = "go" ]; then 
        go run tools/server.go build/${1:-${generator}} --port 8080 --redirect-map redirect.map --browse 
    elif [ ${1:-${generator}} = "python" ]; then
        python tools/server.py build/${1:-${generator}} --port 8080 --redirect-map redirect.map --browse 
    else
        node tools/server.js build/${1:-${generator}} --port 8080 --redirect-map redirect.map --browse 
    fi
}

client_deploy() {
    export ENVIRONMENT=production
    echo "${bold}build${regular}"
    client_build ${generator}
    echo "${bold}deploy${regular}"
    if [ ! -z "${deployment}" ]; then
        deploy/${deployment} deploy build/${generator} $@
    fi
}

client_log() {
    if [ ! -z "${deployment}" ]; then
        deploy/${deployment} log
    fi
}

client_console() {
    if [ ! -z "${deployment}" ]; then
        deploy/${deployment} console
    fi
}

client_watch() {
    export ENVIRONMENT=development
    client_build ${1}
    case "$(uname -s)" in
        Darwin*) 
            if [ -z "$(which fswatch)" ]; then
                brew install fswatch
            fi
            fswatch -r -o . -e build | xargs -n1 ./admin build
            ;;
    esac
}

client_test() {
    echo "${bold}node${regular}"
    ENVIRONMENT=production node tools/generator.js
    echo "${bold}go${regular}"
    ENVIRONMENT=production go run tools/generator.go
    echo "${bold}python${regular}"
    ENVIRONMENT=production python tools/generator.py
    echo "${bold}compare${regular}"
    diff --brief -r build/node/ build/go/
    diff --brief -r build/node/ build/python/
}

command="$1"
shift
case "${command}" in
    "build") client_build $@;;
    "start") client_start $@;;
    "deploy") client_deploy $@;;
    "log") client_log;;
    "console") client_console;;
    "watch") client_watch $@;;
    "test") client_test;;
    *)
        echo;
        echo "Usage: ${bold}$(basename "$0")${regular} <command>"
        echo
        echo "    ${bold}build${regular}      Build the website"
        echo "    ${bold}start${regular}      Build and launch simple local web server"
        echo "    ${bold}deploy${regular}     Build and deploy to production environment"
        echo "    ${bold}log${regular}        Show production log"
        echo "    ${bold}console${regular}    Connect to production environment via SSH"
        echo;
    ;;
esac
